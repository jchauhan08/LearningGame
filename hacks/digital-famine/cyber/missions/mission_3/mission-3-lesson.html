---
layout: post
title: "Alien Defense ‚Äî Mission 3: Secure the Databases"
description: "Learn about hashing techniques and securing databases"
permalink: /digital-famine/cybersecurity-game/mission-3-lesson/
categories: [CSP, Submodule, Database]
tags: [sql, database, fundamentals, sqlite]
author: "Dhyan Soni"
microblog: True
breadcrumb: True
date: 2025-10-26
footer:
  previous: /digital-famine/cybersecurity-game/mission-2-lesson
  home: /digital-famine/cybersecurity-game
  next: /digital-famine/cybersecurity-game/vault-quiz
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission 3: Secure the Databases</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body.mission1-body-bg {
            background:
                radial-gradient(140% 120% at 20% -10%, rgba(120, 214, 255, 0.18) 0%, transparent 60%),
                radial-gradient(120% 120% at 80% 0%, rgba(156, 39, 176, 0.16) 0%, transparent 65%),
                radial-gradient(120% 160% at 50% 100%, rgba(33, 150, 243, 0.12) 0%, transparent 55%),
                linear-gradient(185deg, #020410 0%, #050a1c 45%, #0b132d 100%);
            min-height: 100vh;
            color: #f5f7ff;
            background-attachment: fixed;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse { animation: pulse 2s ease-in-out infinite; }
        .section-hidden { display: none; }

        .mission3-container {
            position: relative;
            padding: 3.5rem 1.8rem 4rem;
            background: radial-gradient(120% 150% at 50% 0%, rgba(32, 45, 80, 0.85) 0%, rgba(10, 14, 28, 0.95) 45%, rgba(2, 4, 12, 0.98) 100%);
            border-radius: 2rem;
            overflow: hidden;
            box-shadow: 0 35px 80px rgba(0, 0, 0, 0.55);
            max-width: 1200px;
            margin: 2rem auto;
        }
        
        .mission3-container::before {
            content: "";
            position: absolute;
            inset: -10% -20%;
            background: radial-gradient(circle at 20% 20%, rgba(120, 214, 255, 0.18), transparent 60%),
                        radial-gradient(circle at 80% 15%, rgba(156, 39, 176, 0.18), transparent 65%),
                        radial-gradient(circle at 50% 80%, rgba(33, 150, 243, 0.12), transparent 55%);
            opacity: 0.85;
            pointer-events: none;
        }
        
        .mission3-container::after {
            content: "";
            position: absolute;
            inset: 0;
            background-image: radial-gradient(rgba(255, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 85px 85px;
            opacity: 0.22;
            mix-blend-mode: screen;
            pointer-events: none;
        }

        .mission3-container > * { position: relative; z-index: 1; }

        .nav-section {
            background: rgba(8, 12, 24, 0.45);
            border: 1px solid rgba(120, 214, 255, 0.12);
            border-radius: 1.25rem;
            padding: 1rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(8px);
        }

        .nav-buttons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            padding: 0.75rem;
            border-radius: 0.75rem;
            background: rgba(15, 20, 35, 0.6);
            border: 1px solid rgba(120, 214, 255, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            color: #e6edff;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            background: rgba(33, 150, 243, 0.2);
        }

        .nav-btn.active {
            background: linear-gradient(90deg, #2196F3 0%, #9c27b0 100%);
            border-color: transparent;
        }

        .nav-divider {
            width: 2rem;
            height: 2px;
            background: rgba(156, 39, 176, 0.3);
            flex-shrink: 0;
        }

        .mission-section {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card, .exercise-card {
            background: rgba(8, 12, 24, 0.85) !important;
            color: #e6edff !important;
            border-radius: 1.25rem !important;
            border: 1px solid rgba(120, 214, 255, 0.2) !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35) !important;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .exercise-card {
            padding: 1.5rem;
            margin: 1rem 0;
        }

        button {
            color: #fff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="text"], input[type="password"], textarea {
            background: rgba(12, 18, 34, 0.9);
            border: 1px solid rgba(120, 214, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #e6edff;
            width: 100%;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
        }

        .code-block {
            background: rgba(12, 18, 34, 0.9);
            border: 1px solid rgba(120, 214, 255, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            color: #9bd9ff;
            overflow-x: auto;
        }

        .result-display {
            background: rgba(12, 18, 34, 0.9);
            border: 1px solid rgba(130, 255, 164, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
            color: #82ffa4;
            font-family: monospace;
        }

        .error-display {
            background: rgba(12, 18, 34, 0.9);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
            color: #ff6b6b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(120, 214, 255, 0.15);
        }

        th {
            color: #78d6ff;
            font-weight: 600;
        }

        h1, h2, h3 { color: #78d6ff; margin: 0 0 1rem; }
        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }

        @media (max-width: 768px) {
            .mission3-container { padding: 1rem; margin: 1rem; }
            .nav-btn { min-width: 80px; padding: 0.5rem; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <body class="mission1-body-bg">
    <div class="mission3-container">
        <!-- Navigation -->
        <div class="nav-section">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="goToSection(0)">
                    <span style="font-size: 2rem">üì°</span>
                    <span style="font-size: 0.75rem">Briefing</span>
                </button>
                <div class="nav-divider"></div>
                <button class="nav-btn" onclick="goToSection(1)">
                    <span style="font-size: 2rem">üìö</span>
                    <span style="font-size: 0.75rem">Learn</span>
                </button>
                <div class="nav-divider"></div>
                <button class="nav-btn" onclick="goToSection(2)">
                    <span style="font-size: 2rem">üîê</span>
                    <span style="font-size: 0.75rem">Hash Lab</span>
                </button>
                <div class="nav-divider"></div>
                <button class="nav-btn" onclick="goToSection(3)">
                    <span style="font-size: 2rem">üõ°Ô∏è</span>
                    <span style="font-size: 0.75rem">Secure DB</span>
                </button>
                <div class="nav-divider"></div>
                <button class="nav-btn" onclick="goToSection(4)">
                    <span style="font-size: 2rem">üèÜ</span>
                    <span style="font-size: 0.75rem">Validation</span>
                </button>
            </div>
        </div>

        <!-- Section 0: Briefing -->
        <div id="section-0" class="mission-section">
            <div class="content-card" style="border-color: rgba(255, 100, 100, 0.5);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 3rem" class="pulse">üì°</span>
                    <h2 style="color: #ff6b6b; margin: 0;">CRITICAL SECURITY BREACH</h2>
                </div>
                <div style="line-height: 1.8;">
                    <p style="font-size: 1.1rem; margin: 1rem 0;"><strong>‚ö†Ô∏è ALERT: PLAINTEXT DATA DISCOVERED</strong></p>
                    <p>Commander, our security audit revealed a catastrophic vulnerability. The launch codes database you built in Mission 1 stores ALL sensitive data in plaintext‚Äîpasswords, codes, everything.</p>
                    <p style="color: #c98fff; margin-top: 1rem;">Alien scanners can read it like an open book. You must learn cryptographic hashing and secure the database before they intercept our codes!</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 0.75rem; text-align: center;">
                            <p style="color: #c98fff; margin: 0; font-weight: 600;">Time</p>
                            <p style="font-size: 1.5rem; margin: 0.5rem 0;">20 min</p>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 0.75rem; text-align: center;">
                            <p style="color: #c98fff; margin: 0; font-weight: 600;">Difficulty</p>
                            <p style="font-size: 1.5rem; margin: 0.5rem 0;">‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ</p>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 0.75rem; text-align: center;">
                            <p style="color: #c98fff; margin: 0; font-weight: 600;">Reward</p>
                            <p style="font-size: 1.5rem; margin: 0.5rem 0; color: #ffd700;">Vault Code</p>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="goToSection(1)" style="width: 100%; padding: 1rem; font-size: 1.1rem;">Begin Security Training</button>
        </div>

        <!-- Section 1: Learn Hashing -->
        <div id="section-1" class="mission-section section-hidden">
            <div class="content-card">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 3rem">üìö</span>
                    <h2 style="margin: 0;">Understanding Cryptographic Hashing</h2>
                </div>
                
                <div style="line-height: 1.8;">
                    <h3 style="color: #82ffa4;">What is Hashing?</h3>
                    <p>Hashing is a <strong>one-way mathematical function</strong> that transforms data into a fixed-length "fingerprint". Unlike encryption, you <em>cannot</em> reverse a hash back to the original data.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;">
                        <div class="exercise-card">
                            <h4 style="color: #ff6b6b;">‚ùå Plaintext Storage</h4>
                            <div class="code-block" style="font-size: 0.9rem;">
password: "SecretCode123"<br>
launch_code: "ALPHA-001"
                            </div>
                            <p style="color: #ff6b6b; font-size: 0.9rem;">Hackers can read everything!</p>
                        </div>
                        <div class="exercise-card">
                            <h4 style="color: #82ffa4;">‚úÖ Hashed Storage</h4>
                            <div class="code-block" style="font-size: 0.9rem;">
password_hash: "9af15b..."<br>
code_hash: "7c3e2a..."
                            </div>
                            <p style="color: #82ffa4; font-size: 0.9rem;">Unreadable to attackers!</p>
                        </div>
                    </div>

                    <h3>Try It Yourself</h3>
                    <div class="exercise-card">
                        <p>Type anything to see SHA-256 hashing in action:</p>
                        <input type="text" id="demoHashInput" placeholder="Type: LAUNCH-CODE-ALPHA" oninput="demoHash()">
                        <div id="demoHashOutput" class="section-hidden result-display"></div>
                    </div>

                    <h3>Key Properties</h3>
                    <ul style="line-height: 2;">
                        <li><strong>Deterministic:</strong> Same input ‚Üí Same hash (always)</li>
                        <li><strong>Fixed Size:</strong> Output is always 64 characters</li>
                        <li><strong>One-Way:</strong> Cannot reverse hash to original</li>
                        <li><strong>Avalanche Effect:</strong> Tiny change ‚Üí Completely different hash</li>
                    </ul>
                </div>
            </div>
            <button onclick="goToSection(2)" style="width: 100%; padding: 1rem;">Continue to Hash Lab</button>
        </div>

        <!-- Section 2: Interactive Hash Lab -->
        <div id="section-2" class="mission-section section-hidden">
            <div class="content-card">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 3rem">üîê</span>
                    <h2 style="margin: 0;">Hash Laboratory</h2>
                </div>

                <div class="exercise-card" style="border-color: rgba(33, 150, 243, 0.4);">
                    <h3 style="color: #78d6ff;">üéØ Challenge: Verify the Avalanche Effect</h3>
                    <p>Hash these two similar codes and observe how different their hashes are:</p>
                    <input type="text" id="avalanche1" placeholder="Type: ALPHA-001" value="ALPHA-001">
                    <input type="text" id="avalanche2" placeholder="Type: ALPHA-002" value="ALPHA-002">
                    <button onclick="testAvalanche()" style="width: 100%; margin-top: 0.5rem;">Compare Hashes</button>
                    <div id="avalancheResult" class="section-hidden"></div>
                </div>

                <div class="exercise-card" style="border-color: rgba(130, 255, 164, 0.4);">
                    <h3 style="color: #82ffa4;">üß™ Exercise: Hash Launch Codes</h3>
                    <p>Your mission: Hash all launch codes from Mission 1. Enter codes separated by commas:</p>
                    <textarea id="codesInput" placeholder="ALPHA-001, BRAVO-002, CHARLIE-003" rows="3"></textarea>
                    <button onclick="hashCodes()" style="width: 100%;">Hash All Codes</button>
                    <div id="codesResult" class="section-hidden"></div>
                </div>

                <div id="lab-complete" class="section-hidden">
                    <div class="result-display" style="text-align: center; padding: 1.5rem;">
                        <h3>‚úÖ Hash Laboratory Complete!</h3>
                        <p>You understand how hashing protects data. Ready to secure the database?</p>
                    </div>
                </div>
            </div>
            <button id="continue-to-db" onclick="goToSection(3)" style="width: 100%; padding: 1rem;" disabled>Continue to Database Security</button>
        </div>

        <!-- Section 3: Secure Database -->
        <div id="section-3" class="mission-section section-hidden">
            <div class="content-card">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 3rem">üõ°Ô∏è</span>
                    <h2 style="margin: 0;">Secure the Database</h2>
                </div>

                <div class="exercise-card" style="border-color: rgba(156, 39, 176, 0.4);">
                    <h3>üìä Current Database Status</h3>
                    <div id="db-loading" style="color: #78d6ff;">Loading database...</div>
                    <div id="db-status" class="section-hidden"></div>
                </div>

                <div class="exercise-card" style="border-color: rgba(255, 215, 0, 0.4);">
                    <h3>üî® Your Mission: Add Password Security</h3>
                    <p>Write SQL to add a <code>password_hash</code> column to the Agents table:</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <textarea id="alter-sql" rows="2" placeholder="ALTER TABLE Agents ADD COLUMN password_hash TEXT;"></textarea>
                        <button onclick="showAlterHint()" id="alter-hint-btn" style="min-width: 110px;">Show Hint</button>
                    </div>
                    <button onclick="runAlterSQL()" id="run-alter-btn" style="width: 100%; margin-top: 0.5rem;">Run SQL</button>
                    <div id="alter-feedback"></div>
                </div>

                <div id="hash-section" class="section-hidden">
                    <div class="exercise-card" style="border-color: rgba(130, 255, 164, 0.4);">
                        <h3>üîê Hash Agent Passwords</h3>
                        <p>Now hash passwords for all agents. The system will do this automatically:</p>
                        <button onclick="hashPasswords()" style="width: 100%;">Generate and Hash Passwords</button>
                        <div id="hash-result" class="section-hidden"></div>
                    </div>
                </div>
            </div>
            <button id="continue-to-validation" onclick="goToSection(4)" style="width: 100%; padding: 1rem;" class="section-hidden">Proceed to Validation</button>
        </div>

        <!-- Section 4: Validation -->
        <div id="section-4" class="mission-section section-hidden">
            <div class="content-card">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 3rem">üèÜ</span>
                    <h2 style="margin: 0;">Mission Validation</h2>
                </div>

                <div class="exercise-card">
                    <h3>Automated Security Check</h3>
                    <button onclick="runValidation()" style="width: 100%;">Run System Validation</button>
                    <div id="validation-results" class="section-hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = null;
        let labProgress = {avalanche: false, codes: false};

        function goToSection(index) {
            document.querySelectorAll('.mission-section').forEach(s => s.classList.add('section-hidden'));
            document.getElementById(`section-${index}`).classList.remove('section-hidden');
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                if (i === index) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            window.scrollTo(0, 0);
        }

        async function sha256(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function demoHash() {
            const input = document.getElementById('demoHashInput').value;
            const output = document.getElementById('demoHashOutput');
            if (!input) {
                output.classList.add('section-hidden');
                return;
            }
            const hash = await sha256(input);
            output.innerHTML = `<strong>Input:</strong> ${input}<br><strong>SHA-256 Hash:</strong> ${hash}<br><strong>Length:</strong> ${hash.length} characters`;
            output.classList.remove('section-hidden');
        }

        async function testAvalanche() {
            const input1 = document.getElementById('avalanche1').value;
            const input2 = document.getElementById('avalanche2').value;
            if (!input1 || !input2) {
                alert('Enter both codes!');
                return;
            }
            const hash1 = await sha256(input1);
            const hash2 = await sha256(input2);
            let diff = 0;
            for (let i = 0; i < hash1.length; i++) if (hash1[i] !== hash2[i]) diff++;
            
            document.getElementById('avalancheResult').innerHTML = `
                <div class="result-display">
                    <strong>Input 1:</strong> ${input1}<br>
                    <strong>Hash:</strong> ${hash1}<br><br>
                    <strong>Input 2:</strong> ${input2}<br>
                    <strong>Hash:</strong> ${hash2}<br><br>
                    <strong>Different Characters:</strong> ${diff}/64 (${(diff/64*100).toFixed(1)}%)<br>
                    <p style="color: #82ffa4; margin-top: 1rem;">‚úÖ Changing one character changed ${diff} hash characters!</p>
                </div>
            `;
            document.getElementById('avalancheResult').classList.remove('section-hidden');
            labProgress.avalanche = true;
            checkLabProgress();
        }

        async function hashCodes() {
            const input = document.getElementById('codesInput').value;
            const codes = input.split(',').map(c => c.trim()).filter(c => c);
            if (codes.length === 0) {
                alert('Enter at least one code!');
                return;
            }
            
            let html = '<div class="result-display"><table><thead><tr><th>Launch Code</th><th>SHA-256 Hash</th></tr></thead><tbody>';
            for (const code of codes) {
                const hash = await sha256(code);
                html += `<tr><td>${code}</td><td style="font-size: 0.85rem;">${hash}</td></tr>`;
            }
            html += '</tbody></table><p style="color: #82ffa4; margin-top: 1rem;">‚úÖ All codes hashed successfully!</p></div>';
            
            document.getElementById('codesResult').innerHTML = html;
            document.getElementById('codesResult').classList.remove('section-hidden');
            labProgress.codes = true;
            checkLabProgress();
        }

        function checkLabProgress() {
            if (labProgress.avalanche && labProgress.codes) {
                document.getElementById('lab-complete').classList.remove('section-hidden');
                document.getElementById('continue-to-db').disabled = false;
            }
        }

        function showAlterHint() {
            const hintDiv = document.getElementById('alter-feedback');
            hintDiv.innerHTML = `
                <div class="result-display" style="margin-top: 1rem; background: rgba(130, 255, 164, 0.1); padding: 1rem; border-radius: 0.5rem;">
                    <p><strong>üí° Hint:</strong></p>
                    <p>Use the ALTER TABLE command to add a new column:</p>
                    <code>ALTER TABLE table_name<br>ADD COLUMN column_name data_type;</code>
                    <p style="margin-top: 0.5rem;">For password hashes, we need TEXT data type to store the hash string.</p>
                </div>
            `;
        }

        function runAlterSQL() {
            const sql = document.getElementById('alter-sql').value.trim();
            const feedbackDiv = document.getElementById('alter-feedback');
            
            try {
                // Check if the SQL is correct
                const expectedSQL = "ALTER TABLE Agents ADD COLUMN password_hash TEXT";
                const normalizedSQL = sql.replace(/;?\s*$/, '').toLowerCase();
                const normalizedExpected = expectedSQL.toLowerCase();

                if (normalizedSQL === normalizedExpected) {
                    db.run(sql);
                    feedbackDiv.innerHTML = `
                        <div class="result-display" style="margin-top: 1rem; background: rgba(130, 255, 164, 0.1); padding: 1rem; border-radius: 0.5rem;">
                            <p>‚úÖ Success! Column added to the Agents table.</p>
                        </div>
                    `;
                    // Show the next section for hashing passwords
                    document.getElementById('hash-section').classList.remove('section-hidden');
                    // Update the database status display
                    showDBStatus();
                } else {
                    feedbackDiv.innerHTML = `
                        <div class="result-display" style="margin-top: 1rem; background: rgba(255, 107, 107, 0.1); padding: 1rem; border-radius: 0.5rem;">
                            <p>‚ùå That's not quite right. Check your SQL syntax and try again.</p>
                        </div>
                    `;
                }
            } catch (e) {
                feedbackDiv.innerHTML = `
                    <div class="result-display" style="margin-top: 1rem; background: rgba(255, 107, 107, 0.1); padding: 1rem; border-radius: 0.5rem;">
                        <p>‚ùå Error: ${e.message}</p>
                    </div>
                `;
            }
        }

        async function hashPasswords() {
            try {
                // Generate and hash random passwords for each agent
                const result = db.exec('SELECT codename FROM Agents');
                const agents = result[0].values;
                
                for (const [codename] of agents) {
                    // Generate a random password based on codename
                    const password = `${codename}-${Math.random().toString(36).substring(2, 8)}`;
                    // Hash the password
                    const hash = await sha256(password);
                    // Update the database with the hash
                    db.run('UPDATE Agents SET password_hash = ? WHERE codename = ?', [hash, codename]);
                }

                document.getElementById('hash-result').innerHTML = `
                    <div class="result-display">
                        <p>‚úÖ Success! Generated and stored secure password hashes for all agents.</p>
                    </div>
                `;
                document.getElementById('hash-result').classList.remove('section-hidden');
                document.getElementById('continue-to-validation').classList.remove('section-hidden');
            } catch (e) {
                document.getElementById('hash-result').innerHTML = `
                    <div class="error-display">
                        <p>‚ùå Error: ${e.message}</p>
                    </div>
                `;
            }
        }

        function showDBStatus() {
            try {
                const results = db.exec('PRAGMA table_info(Agents)');
                const columns = results[0].values.map(col => ({
                    name: col[1],
                    type: col[2]
                }));
                
                let html = '<div class="result-display">';
                html += '<h4 style="margin-bottom: 1rem;">üìã Agents Table Schema:</h4>';
                html += '<table style="width: 100%;"><thead><tr><th>Column</th><th>Type</th></tr></thead><tbody>';
                
                columns.forEach(col => {
                    html += `<tr><td>${col.name}</td><td>${col.type}</td></tr>`;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('db-status').innerHTML = html;
                document.getElementById('db-status').classList.remove('section-hidden');
            } catch (e) {
                document.getElementById('db-status').innerHTML = `<p style="color: #ff6b6b;">Error showing database status: ${e.message}</p>`;
            }
        }

        async function initDatabase() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                // Create an in-memory database and populate with sample Agents (simulating Mission 1)
                db = new SQL.Database();

                db.run(`CREATE TABLE IF NOT EXISTS Agents (
                    agent_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    codename TEXT UNIQUE,
                    clearance_level INTEGER,
                    location TEXT,
                    status TEXT
                )`);

                // Insert sample agents if table is empty
                try {
                    const res = db.exec('SELECT COUNT(*) AS cnt FROM Agents');
                    const count = res && res[0] && res[0].values && res[0].values[0] ? res[0].values[0][0] : 0;
                    if (!count) {
                        const agents = [
                            ['Shadow', 9, 'New York', 'active'],
                            ['Phoenix', 7, 'Tokyo', 'active'],
                            ['Cipher', 8, 'Berlin', 'active'],
                            ['Ghost', 10, 'Classified', 'standby'],
                            ['Radar', 6, 'London', 'compromised']
                        ];
                        agents.forEach(a => db.run('INSERT INTO Agents (codename, clearance_level, location, status) VALUES (?, ?, ?, ?)', a));
                    }
                } catch (e) {
                    // ignore insert errors
                }

                document.getElementById('db-loading').classList.add('section-hidden');
                showDBStatus();
                document.getElementById('alter-sql').disabled = false;
                document.getElementById('run-alter-btn').disabled = false;
                document.getElementById('alter-hint-btn').disabled = false;
            } catch (e) {
                document.getElementById('db-loading').textContent = 'Failed to load database: ' + e.message;
            }
        }

        function runValidation() {
            const checks = [];
            let score = 0;
            
            // Check 1: Database exists
            if (db) {
                checks.push({name: 'Database Connection', pass: true});
                score++;
            } else {
                checks.push({name: 'Database Connection', pass: false});
            }
            
            // Check 2: Agents table has password_hash column
            try {
                const schema = db.exec("PRAGMA table_info(Agents)");
                const hasPasswordCol = schema[0].values.some(col => col[1] === 'password_hash');
                checks.push({name: 'Password Hash Column', pass: hasPasswordCol});
                if (hasPasswordCol) score++;
            } catch (e) {
                checks.push({name: 'Password Hash Column', pass: false});
            }
            
            // Check 3: All agents have hashed passwords
            try {
                const result = db.exec('SELECT password_hash FROM Agents WHERE password_hash IS NOT NULL');
                const allHashed = result[0] && result[0].values.length === 5;
                checks.push({name: 'All Passwords Hashed', pass: allHashed});
                if (allHashed) score++;
            } catch (e) {
                checks.push({name: 'All Passwords Hashed', pass: false});
            }
            
            // Check 4: Hashes are valid SHA-256 (64 characters)
            try {
                const result = db.exec('SELECT password_hash FROM Agents');
                const validHashes = result[0].values.every(row => row[0] && row[0].length === 64);
                checks.push({name: 'Valid SHA-256 Hashes', pass: validHashes});
                if (validHashes) score++;
            } catch (e) {
                checks.push({name: 'Valid SHA-256 Hashes', pass: false});
            }
            
            let html = '<div class="exercise-card" style="margin-top: 1rem;"><h3>Validation Results: ' + score + '/4</h3>';
            checks.forEach(check => {
                const color = check.pass ? 'rgba(130, 255, 164, 0.2)' : 'rgba(255, 107, 107, 0.2)';
                const icon = check.pass ? '‚úÖ' : '‚ùå';
                html += `<div style="background: ${color}; padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem;">${icon} ${check.name}</div>`;
            });
            
            if (score === 4) {
                html += `
                    <div style="background: rgba(255, 215, 0, 0.2); border: 2px solid rgba(255, 215, 0, 0.5); border-radius: 1rem; padding: 2rem; margin-top: 2rem; text-align: center;">
                        <h2 style="color: #ffd700; font-size: 2rem; margin-bottom: 1rem;">üéâ MISSION SUCCESS!</h2>
                        <p style="font-size: 1.2rem; margin-bottom: 1.5rem;">Database secured with cryptographic hashing!</p>
                        <div style="background: rgba(0,0,0,0.4); padding: 1.5rem; border-radius: 0.75rem; margin: 1rem 0;">
                            <p style="margin-bottom: 0.5rem;">üîì <strong>Vault Code Unlocked:</strong></p>
                            <code style="font-size: 2.5rem; color: #82ffa4; font-weight: bold; letter-spacing: 0.2rem;">CHARLIE-9R5T</code>
                        </div>
                        <p style="color: #82ffa4; margin-top: 1rem;">Save this code for the final vault!</p>
                    </div>
                `;
            } else {
                html += '<div style="background: rgba(255, 107, 107, 0.2); padding: 1rem; margin-top: 1rem; border-radius: 0.5rem;">‚ö†Ô∏è Complete all security requirements to unlock the vault code.</div>';
            }
            
            html += '</div>';
            document.getElementById('validation-results').innerHTML = html;
            document.getElementById('validation-results').classList.remove('section-hidden');
        }

        // Initialize database when page loads
        window.addEventListener('load', () => {
            // Wait until user reaches section 3 to init database
            const observer = new MutationObserver((mutations) => {
                const section3 = document.getElementById('section-3');
                if (!section3.classList.contains('section-hidden') && !db) {
                    initDatabase();
                }
            });
            
            observer.observe(document.getElementById('section-3'), {
                attributes: true,
                attributeFilter: ['class']
            });
        });
    </script>
</body>
</html>